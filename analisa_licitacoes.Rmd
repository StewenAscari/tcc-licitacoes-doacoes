---
title: "Tcc: relação entre empresas que fazem licitações e doeações em campanha eleitoral"
output: html_notebook
---

```{r setup}
library(dplyr)
library(electionsBR)
library(lubridate)
library(ggplot2)
library(readr)
library(stringr)
```

```{r}
licitacao <- read_delim("dados/TCE-PB-SAGRES-Licitacao_Esfera_Municipal.txt", delim = "|", na = "NULL", quote = "") %>%
  filter(!is.na(de_ugestora))

propostas <- read_delim("dados/TCE-PB-SAGRES-Propostas_Licitacao_Esfera_Municipal.txt", delim = "|", na = "NULL")

gestoras <- read_delim("dados/TCE-PB-SAGRES-Participantes_Licitacao_Esfera_Municipal.txt", delim = "|", na = "NULL")

doacoes2012 <- read_delim("dados/receitas_candidatos_2012_PB.txt", delim = ";", na= "#NULO", 
                      locale = locale(decimal_mark = ",", encoding = "latin1"))

doacoes2016 <- read_delim("dados/receitas_candidatos_prestacao_contas_final_2016_PB.txt", delim = ";", na = "#NULO",
                      locale = locale(decimal_mark = ",", encoding = "latin1"))

municipios <- read_csv("dados/municipios_pb.csv", locale = locale(encoding = "latin1"))

prefeitos_pb_2016 <- read_csv("dados/prefeitos_eleitos_pb_2016.csv")

#votos_PB <- vote_mun_zone_local(2016, uf = "PB", export = TRUE)
#prefeitos_pb_2016 <- votos_PB %>%
#  filter(DESC_SIT_CAND_TOT == "ELEITO", DESCRICAO_CARGO == "PREFEITO") %>%
#  select(ANO_ELEICAO, NOME_MUNICIPIO, NOME_CANDIDATO, SIGLA_PARTIDO, NUMERO_PARTIDO, COMPOSICAO_LEGENDA) %>%
#  distinct()
#write_csv(prefeitos_pb_2016, "dados/prefeitos_eleitos_pb_2016.csv")

```

```{r}
data_inicial <- dmy("01/01/2017") 

participacoes <- propostas %>%
  mutate(cd_ugestora = as.character(cd_ugestora)) %>%
  left_join(licitacao, by = c("cd_ugestora", "de_ugestora", "nu_licitacao" = "nu_Licitacao")) %>%
  filter(dmy(dt_Homologacao) >= data_inicial) %>%
  group_by(cd_ugestora, de_ugestora, nu_cpfcnpj, no_proponente, nu_licitacao) %>%
  summarise(n_propostas = n(),
            n_vencedora = sum(de_situacaoproposta == "Vencedora"),
            valor_recebido = sum(ifelse(de_situacaoproposta == "Vencedora", vl_ofertado, 0))) %>%
  group_by(cd_ugestora, de_ugestora, nu_cpfcnpj, no_proponente) %>%
  summarise(n_licitacoes = n(),
            n_vencedora = sum(n_vencedora >= 1),
            valor_recebido = sum(valor_recebido)) %>%
  arrange(desc(valor_recebido))

```


```{r}
ggplot(participacoes, aes("valor", valor_recebido)) +
  geom_boxplot() +
  scale_y_log10()

# Filtrando outliers com valores recebidos acima de 1000000000
participacoes <- filter(participacoes, valor_recebido < 1000000000)
```

```{r}
ggplot(participacoes, aes("", valor_recebido)) +
  geom_boxplot() +
  scale_y_log10() +
  coord_flip()

participacoes %>%
  arrange(desc(valor_recebido))
```

```{r}
doacoes_totais <- doacoes2016 %>%
  group_by(`CPF/CNPJ do doador`, `Nome do doador`, `Nome da UE`, `Nome candidato`, `Sigla  Partido`) %>%
  summarise(n_doacoes = n(),
            total_doado = sum(`Valor receita`))

doacoes_totais
```

```{r}
doacoes_gerais <- doacoes2016 %>%
  group_by(`Nome do doador (Receita Federal)`) %>%
  summarise(n_doacoes =  n(),
            total_doado = sum(`Valor receita`))

participacoes_gerais <- participacoes %>%
  group_by(no_proponente) %>%
  summarise(n_licitacoes = sum(n_licitacoes),
            n_vencedora = sum(n_vencedora),
            total_recebido = sum(valor_recebido))

doacoes_gerais %>%
  inner_join(participacoes_gerais, by = c("Nome do doador (Receita Federal)" = "no_proponente")) %>%
  arrange(desc(total_recebido))
```

```{r}
participacoes_municipio <- participacoes %>%
  mutate(cd_Municipio = str_sub(cd_ugestora, -3)) %>%
  left_join(select(municipios, cd_Municipio, de_Municipio)) %>%
  mutate(de_Municipio = toupper(de_Municipio)) %>%
  group_by(nu_cpfcnpj, nome_licitante = no_proponente, municipio = de_Municipio) %>%
  summarise(n_licitacoes = sum(n_licitacoes),
            n_vencedora = sum(n_vencedora),
            valor_recebido = sum(valor_recebido, na.rm = TRUE)) %>%
  left_join(select(prefeitos_pb_2016, prefeito = NOME_CANDIDATO, municipio = NOME_MUNICIPIO))
participacoes_municipio

doacoes_municipio <- doacoes2016 %>%
  group_by(nome_doador = `Nome do doador (Receita Federal)`,
           nome_candidato = `Nome candidato`,
           municipio = `Nome da UE`) %>%
  summarise(n_doacoes =  n(),
            total_doado = sum(`Valor receita`, na.rm = TRUE))
doacoes_municipio

doacoes_participacoes_prefeito <- doacoes_municipio %>%
  inner_join(participacoes_municipio, by = c("nome_doador" = "nome_licitante", "nome_candidato" = "prefeito", "municipio"))

doacoes_participacoes_prefeito %>%
  arrange(desc(total_doado))


```

```{r}
licitante <- "PAULO DALIA TEIXEIRA"

propostas %>%
  filter(no_proponente== licitante) %>% 
  mutate(cd_ugestora = as.character(cd_ugestora)) %>%
  left_join(licitacao, by = c("cd_ugestora", "de_ugestora", "nu_licitacao" = "nu_Licitacao"))

```
# Candidatos do ano de 2012 da PB

## Quais são os maiores participantes
## Quais são os maiores vencedores
## Quais são os maiores vencedores
